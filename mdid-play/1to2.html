<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WHMID to MIDI Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.13/build/Midi.js"></script>
</head>
<body>
    <h1>WHMID to MIDI Converter</h1>
    <input type="file" id="whmidFileInput" accept=".whmid" />
    <button id="convertToMidiButton">変換してMIDIに保存</button>

    <script>
        document.getElementById('convertToMidiButton').addEventListener('click', async () => {
            const file = document.getElementById('whmidFileInput').files[0];
            if (!file) {
                alert('WHMIDファイルを選択してください。');
                return;
            }
            
            const whmidData = await readWhmidFile(file);
            const midiData = convertWhmidToMidi(whmidData);

            const blob = new Blob([midiData], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'output.mid';
            a.click();
            URL.revokeObjectURL(url);
        });

        function readWhmidFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    resolve(new Uint8Array(event.target.result));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function convertWhmidToMidi(whmid) {
            const version = whmid[0];
            const tempo = whmid[1];
            const trackCount = new Uint16Array(whmid.buffer, 2, 1)[0];

            const midi = new Midi();
            midi.header.bpm = tempo;

            for (let i = 0; i < trackCount; i++) {
                const track = midi.addTrack();
                const offset = 4 + (i * 26); // 各トラックのデータの開始位置

                const pitch = new Uint16Array(whmid.buffer, offset, 1)[0];
                const instrumentId = new Uint16Array(whmid.buffer, offset + 2, 1)[0];
                const duration = new Uint32Array(whmid.buffer, offset + 4, 1)[0];
                const durationDivisor = new Uint32Array(whmid.buffer, offset + 8, 1)[0];
                const startTime = new Uint32Array(whmid.buffer, offset + 12, 1)[0];
                const timingDivisor = new Uint32Array(whmid.buffer, offset + 16, 1)[0];

                // 音の長さを時間に変換
                const durationInSeconds = duration / 1000;

                // ノートを追加する
                track.addNote({
                    midi: pitch,
                    time: startTime / 1000, // WHMIDから秒に変換
                    duration: durationInSeconds,
                    velocity: 0.5, // デフォルトのベロシティ
                    name: `Note ${pitch}` // 名前を設定する例
                });
            }

            return midi.toArray();
        }
    </script>
</body>
</html>
