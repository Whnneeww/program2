<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WHMID to MIDI Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.13/build/Midi.js"></script>
</head>
<body>
    <h1>WHMID to MIDI Converter</h1>
    <input type="file" id="whmidFileInput" accept=".whmid" />
    <button id="convertToMidiButton">変換してMIDIに保存</button>

    <script>
        document.getElementById('convertToMidiButton').addEventListener('click', async () => {
            const file = document.getElementById('whmidFileInput').files[0];
            if (!file) {
                alert('WHMIDファイルを選択してください。');
                return;
            }
            
            const whmidData = await readWhmidFile(file);
            const midiData = convertWhmidToMidi(whmidData);

            const blob = new Blob([midiData], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'output.mid';
            a.click();
            URL.revokeObjectURL(url);
        });

        function readWhmidFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    resolve(new Uint8Array(event.target.result));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function convertWhmidToMidi(whmid) {
            const version = whmid[0];
            const tempo = whmid[1]; // ヘッダーからテンポを読み取る(適宜構造に合わせる)
            const trackCount = new Uint16Array(whmid.buffer, 2, 1)[0]; // トラック数を取得

            const midi = new Midi();
            midi.header.bpm = 120; // デフォルトのBPMを設定（適宜調整）

            for (let i = 0; i < trackCount; i++) {
                const track = midi.addTrack();
                const offset = 4 + (i * 26); // 各トラックのデータの開始位置

                // WHMIDからデータを取得
                const noteCount = new Uint16Array(whmid.buffer, offset, 1)[0]; // ノート数
                offset += 2; // 次のデータへ移動

                for (let n = 0; n < noteCount; n++) {
                    const pitch = new Uint16Array(whmid.buffer, offset + n * 8, 2)[0]; // 音の高さ
                    const duration = new Uint16Array(whmid.buffer, offset + n * 8 + 2, 2)[0]; // 音の持続時間
                    const startTime = new Uint32Array(whmid.buffer, offset + n * 8 + 4, 1)[0]; // 開始時間

                    // MIDIノートを追加
                    track.addNote({
                        midi: pitch,
                        time: startTime / 1000, // WHMIDから秒に変換
                        duration: duration / 1000, // 音の持続時間も秒に変換
                        velocity: 0.5 // ベロシティの設定
                    });
                }
            }

            return midi.toArray();
        }
    </script>
</body>
</html>
