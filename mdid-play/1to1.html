<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MIDI to WHMID Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.13/build/Midi.js"></script>
</head>
<body>
    <h1>MIDI to WHMID Converter</h1>
    <input type="file" id="midiFileInput" accept=".mid" />
    <button id="convertToWhmidButton">変換してWHMIDに保存</button>

    <script>
        document.getElementById('convertToWhmidButton').addEventListener('click', async () => {
            const file = document.getElementById('midiFileInput').files[0];
            if (!file) {
                alert('MIDIファイルを選択してください。');
                return;
            }

            const midiData = await readMidiFile(file);
            const whmidData = convertMidiToWhmid(midiData);

            const blob = new Blob([whmidData], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'output.whmid';
            a.click();
            URL.revokeObjectURL(url);
        });

        function readMidiFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const midiArray = new Uint8Array(event.target.result);
                    const midi = new Midi(midiArray);
                    resolve(midi);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function convertMidiToWhmid(midi) {
            // WHMIDヘッダーの設定
            const header = new Uint8Array(4);
            header[0] = 0; // バージョン: 0
            header[1] = midi.header.bpm; // テンポ（値を適切に設定）

            // トラック数
            const trackCount = midi.tracks.length;
            const trackBuffer = new Uint16Array([trackCount]);

            const soundData = [];
            for (let track of midi.tracks) {
                for (let note of track.notes) {
                    const pitch = note.midi; // 音の高さ
                    const instrumentId = track.instrument ? track.instrument : 0; // 楽器
                    const duration = note.duration * 1000; // 持続時間 (ミリ秒)
                    const startTime = note.time * 1000; // 開始時間 (ミリ秒)

                    // WHMID規格に従ってデータを追加
                    const noteData = new Uint8Array(26); // 各ノートのデータサイズを確認し調整

                    let offset = 0;
                    // 以下の行でオフセットを正確に管理
                    new Uint16Array(noteData.buffer, offset, 1)[0] = pitch; offset += 2;
                    new Uint16Array(noteData.buffer, offset, 1)[0] = instrumentId; offset += 2;
                    new Uint32Array(noteData.buffer, offset, 1)[0] = duration; offset += 4;
                    new Uint32Array(noteData.buffer, offset, 1)[0] = 10; offset += 4; // ダミーの割る値
                    new Uint32Array(noteData.buffer, offset, 1)[0] = startTime; offset += 4; // ミリ秒
                    new Uint32Array(noteData.buffer, offset, 1)[0] = 10; offset += 4; // ダミーの割る値
                    new Uint16Array(noteData.buffer, offset, 1)[0] = midi.header.bpm; offset += 2;
                    new Uint16Array(noteData.buffer, offset, 1)[0] = trackCount; // トラック情報

                    soundData.push(noteData);
                }
            }

            // WHMIDデータの組み立て
            const fullData = new Uint8Array(header.length + trackBuffer.byteLength + soundData.reduce((acc, val) => acc + val.length, 0));
            let index = 0;
            fullData.set(header, index); index += header.length;
            fullData.set(new Uint8Array(trackBuffer.buffer), index); index += trackBuffer.byteLength;

            // 音データを全て追加
            soundData.forEach(data => {
                fullData.set(data, index); index += data.length;
            });

            return fullData;
        }
    </script>
</body>
</html>
